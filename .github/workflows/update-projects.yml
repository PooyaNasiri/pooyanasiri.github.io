name: Update Recent Projects

on:
  schedule:
    - cron: "0 * * * *"  # Every hour
  workflow_dispatch:      # Also lets you trigger manually

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch recent repos and commits
        run: |
          mkdir -p data
          curl -s https://api.github.com/users/PooyaNasiri/repos?per_page=100 > repos.json

          echo "[" > data/recent.json
          count=0

          for repo in $(jq -r '.[].name' repos.json); do
            if [ "$count" -ge 3 ]; then break; fi
            commit_info=$(curl -s "https://api.github.com/repos/PooyaNasiri/$repo/commits?per_page=1")
            commit_date=$(echo "$commit_info" | jq -r '.[0].commit.committer.date')

            jq --arg repo "$repo" \
               --arg url "https://github.com/PooyaNasiri/$repo" \
               --arg desc "$(jq -r ".[] | select(.name==\"$repo\") | .description" repos.json)" \
               --arg date "$commit_date" \
               -n '{name: $repo, html_url: $url, description: $desc, last_commit: $date}' >> data/recent.json

            echo "," >> data/recent.json
            count=$((count + 1))
          done

          sed -i '$ s/,$//' data/recent.json
          echo "]" >> data/recent.json

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/recent.json
          git commit -m "Update recent projects" || echo "No changes"
          git push
